name: CI/CD Asistente Agenda IA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test with secret
      env:
        GEMINI_API_KEY: ${{ secrets.KEY_AUDIFARMA }}
        AGENDA_FILE: agenda_test.xlsx
        COMPANY_NAME: Audifarma
      run: |
        python -c "
        import os
        from agenda_assistant.infrastructure.hexagonal_configurator import HexagonalConfigurator
        print('✅ Configuración exitosa')
        print(f'API Key configurada: {bool(os.getenv(\"GEMINI_API_KEY\"))}')
        "

  docker:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t agenda-ai .
    
    - name: Test Docker container
      env:
        GEMINI_API_KEY: ${{ secrets.KEY_AUDIFARMA }}
      run: |
        docker run --rm -e GEMINI_API_KEY=$GEMINI_API_KEY agenda-ai python -c "
        import os
        print('✅ Docker funcionando')
        print(f'API Key en Docker: {bool(os.getenv(\"GEMINI_API_KEY\"))}')
        "